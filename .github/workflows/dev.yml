name: "ğŸš€ CI/CD Development"

on:
  push:
    branches:
      - "*"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Development

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Build Docker Image
        id: meta
        run: docker build -t farellkresnanda/sipantau:latest .

      - name: ğŸ›  Build and Push Docker Image
        run: docker push farellkresnanda/sipantau:latest

      - name: ğŸš¢ Deploy to VPS Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ” Pulling latest Docker image..."
            docker pull farellkresnanda/sipantau:latest

            echo "ğŸ›‘ Stopping old container (if exists)..."
            docker stop sipantau || true
            docker rm sipantau || true

            echo "ğŸ“‚ Ensure data dirs..."
            mkdir -p /srv/sipantau/storage /srv/sipantau/bootstrap-cache

            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name sipantau \
              --restart unless-stopped \
              -p "${{ secrets.PORT }}:3000" \
              -e APP_ENV=production \
              -e APP_DEBUG=false \
              -e APP_URL="https://sipantau.kresnansite.my.id" \
              -e LOG_CHANNEL=stderr \
              -e RUN_MIGRATIONS=true \
              -e DB_CONNECTION="mysql" \
              -e DB_HOST="${{ secrets.DB_HOST }}" \
              -e DB_PORT="${{ secrets.DB_PORT || 3306 }}" \
              -e DB_DATABASE="${{ secrets.DB_DATABASE }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e SESSION_DRIVER="database" \
              -e QUEUE_CONNECTION="database" \
              -v /srv/sipantau/storage:/var/www/html/storage \
              -v /srv/sipantau/bootstrap-cache:/var/www/html/bootstrap/cache \
              farellkresnanda/sipantau:latest

            echo "ğŸ§¹ Cleaning up..."
            docker system prune -f

            echo "âœ… Deployment to Development environment completed!"